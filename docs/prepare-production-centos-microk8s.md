<img src="images/koncierge-logo.svg" alt="Koncierge" style="float: right; margin-right: 10px; margin-left: 10px;  height: 150px" />

# Prepare Kubernetes for a production environment with a dedicated server running Centos using Microk8s

[See other configuration options](prepare-k8s.md).

## Step 1: Install Kubernetes

### Step 1.1: Install Microk8s

Follow the instructions at https://microk8s.io/docs/install-alternatives

Install snapd needed for Microk8s:

See https://snapcraft.io/install/microk8s/centos

```shell
# sudo yum install epel-release
# sudo yum install snapd
# sudo systemctl enable --now snapd.socket
Created symlink from /etc/systemd/system/sockets.target.wants/snapd.socket to /usr/lib/systemd/system/snapd.socket.
# sudo ln -s /var/lib/snapd/snap /snap
```

Install Microk8s using snap:

```shell
# sudo snap install microk8s --classic
error: too early for operation, device not yet seeded or device model not acknowledged
# yum reinstall snapd
# sudo snap install microk8s --classic
2023-09-28T09:32:30Z INFO Waiting for automatic snapd restart...
microk8s (1.27/stable) v1.27.5 from Canonicalâœ“ installed
```

To confirm that it is working:

```shell
$ microk8s version
MicroK8s v1.27.5 revision 5891
```
## Step 2: Setup tools

### Step 2.1: Setup kubectl

Setup an alias so that the command "kubectl" executes "microk8s kubectl".

#### Example: Mac

Make a backup of your `.bash_profile` file:

```shell
$ cp ~/.bash_profile ~/.bash_profile.bak
$ nano ~/.bash_profile
```

Add this line at the end of the file:
```shell
alias kubectl='microk8s kubectl'
```

View the changes and make them active:

```shell
$ diff ~/.bash_profile.bak ~/.bash_profile
35a36,38
> 
> alias kubectl='microk8s kubectl'
> 
$ source ~/.bash_profile
```

Confirm that it is working:

```shell
$ kubectl get nodes
NAME          STATUS   ROLES    AGE   VERSION
microk8s-vm   Ready    <none>   8h    v1.27.5
$ kubectl config view
apiVersion: v1
clusters:
- cluster:
    certificate-authority-data: DATA+OMITTED
    server: https://<ip-address>:16443
  name: microk8s-cluster
contexts:
- context:
    cluster: microk8s-cluster
    user: admin
  name: microk8s
current-context: microk8s
kind: Config
preferences: {}
users:
- name: admin
  user:
    token: REDACTED
```

### Step 2.2: Setup k9s

Follow the instructions at https://k9scli.io/topics/install/

Point **k9s** at microk8s:

```shell
$ cp ~/.kube/config ~/.kube/config.bak
$ kubectl config view --raw > ~/.kube/config
$ k9s
```

You should see something like this:

![k9s_showing_microk8s.png](images%2Fk9s_showing_microk8s.png)


## Steps 3: Setup and test domain names

You need to set up DNS so that the domain name of each of our environments points to the Kubernetes cluster where that environment is deployed.

For example, in [Example 2](..%2Fexamples%2Fexample2%2FREADME.md), the production environment is deployed to _example.com_.
In this case the domain _example.com_ will point to the _frontend_ service and _api.example.com_ will point to the _backend_ service.
It is the [ingress](https://kubernetes.io/docs/concepts/services-networking/ingress/) that is generated by Koncierge that handles the sub-domain,
but the main domain must be set up to point to the cluster where the production environment is deployed.

If you want to test on your local environment, you can set up a _test_ domain on your laptop that points to your local cluster.
The [ingress](https://kubernetes.io/docs/concepts/services-networking/ingress/) that is generated will then point _todo.test_ to the
_frontend_ service and _api.todo.test_ to the _backend_ service.

### Step 3.1: Enable required addons in microk8s

Clean microk8s:

```shell
$ microk8s disable ha-cluster --force
Infer repository core for addon ha-cluster
Reverting to a non-HA setup
Generating new cluster certificates.
Waiting for node to start. .  
Enabling flanneld and etcd
HA disabled
$ microk8s status
microk8s is running
high-availability: no
  datastore endpoints:
    127.0.0.1:12379
addons:
  enabled:
    helm                 # (core) Helm - the package manager for Kubernetes
    helm3                # (core) Helm 3 - the package manager for Kubernetes
  disabled:
    cert-manager         # (core) Cloud native certificate management
    community            # (core) The community addons repository
    dashboard            # (core) The Kubernetes dashboard
    dns                  # (core) CoreDNS
    gpu                  # (core) Automatic enablement of Nvidia CUDA
    ha-cluster           # (core) Configure high availability on the current node
    host-access          # (core) Allow Pods connecting to Host services smoothly
    hostpath-storage     # (core) Storage class; allocates storage from host directory
    ingress              # (core) Ingress controller for external access
    kube-ovn             # (core) An advanced network fabric for Kubernetes
    mayastor             # (core) OpenEBS MayaStor
    metallb              # (core) Loadbalancer for your Kubernetes cluster
    metrics-server       # (core) K8s Metrics Server for API access to service metrics
    minio                # (core) MinIO object storage
    observability        # (core) A lightweight observability stack for logs, traces and metrics
    prometheus           # (core) Prometheus operator for monitoring and logging
    rbac                 # (core) Role-Based Access Control for authorisation
    registry             # (core) Private image registry exposed on localhost:32000
    storage              # (core) Alias to hostpath-storage add-on, deprecated
```

Enable persistent storage on the host machine's file system:

```shell
$ microk8s enable hostpath-storage
Infer repository core for addon hostpath-storage
Enabling default storage class.
WARNING: Hostpath storage is not suitable for production environments.
         A hostpath volume can grow beyond the size limit set in the volume claim manifest.

deployment.apps/hostpath-provisioner created
storageclass.storage.k8s.io/microk8s-hostpath created
serviceaccount/microk8s-hostpath created
clusterrole.rbac.authorization.k8s.io/microk8s-hostpath created
clusterrolebinding.rbac.authorization.k8s.io/microk8s-hostpath created
Storage will be available soon.
$ microk8s status
microk8s is running
high-availability: no
  datastore endpoints:
    127.0.0.1:12379
addons:
  enabled:
    helm                 # (core) Helm - the package manager for Kubernetes
    helm3                # (core) Helm 3 - the package manager for Kubernetes
    hostpath-storage     # (core) Storage class; allocates storage from host directory
    storage              # (core) Alias to hostpath-storage add-on, deprecated
  disabled:
    cert-manager         # (core) Cloud native certificate management
    community            # (core) The community addons repository
    dashboard            # (core) The Kubernetes dashboard
    dns                  # (core) CoreDNS
    gpu                  # (core) Automatic enablement of Nvidia CUDA
    ha-cluster           # (core) Configure high availability on the current node
    host-access          # (core) Allow Pods connecting to Host services smoothly
    ingress              # (core) Ingress controller for external access
    kube-ovn             # (core) An advanced network fabric for Kubernetes
    mayastor             # (core) OpenEBS MayaStor
    metallb              # (core) Loadbalancer for your Kubernetes cluster
    metrics-server       # (core) K8s Metrics Server for API access to service metrics
    minio                # (core) MinIO object storage
    observability        # (core) A lightweight observability stack for logs, traces and metrics
    prometheus           # (core) Prometheus operator for monitoring and logging
    rbac                 # (core) Role-Based Access Control for authorisation
    registry             # (core) Private image registry exposed on localhost:32000
```

Enable DNS:

(Note that 1.1.1.1 below is Dloudflare's DNS server. You could substitute it for another one.)

(You might have to temporarily disable the firewall with `systemctl stop firewalld` to get the below to work.)
```shell
$ microk8s enable dns:1.1.1.1
Infer repository core for addon dns
Enabling DNS
Will use  1.1.1.1 as upstream nameservers
Applying manifest
serviceaccount/coredns created
configmap/coredns created
deployment.apps/coredns created
service/kube-dns created
clusterrole.rbac.authorization.k8s.io/coredns created
clusterrolebinding.rbac.authorization.k8s.io/coredns created
DNS is enabled
$ microk8s status
microk8s is running
high-availability: no
  datastore endpoints:
    127.0.0.1:12379
addons:
  enabled:
    dns                  # (core) CoreDNS
    helm                 # (core) Helm - the package manager for Kubernetes
    helm3                # (core) Helm 3 - the package manager for Kubernetes
    hostpath-storage     # (core) Storage class; allocates storage from host directory
    storage              # (core) Alias to hostpath-storage add-on, deprecated
  disabled:
    cert-manager         # (core) Cloud native certificate management
    community            # (core) The community addons repository
    dashboard            # (core) The Kubernetes dashboard
    gpu                  # (core) Automatic enablement of Nvidia CUDA
    ha-cluster           # (core) Configure high availability on the current node
    host-access          # (core) Allow Pods connecting to Host services smoothly
    ingress              # (core) Ingress controller for external access
    kube-ovn             # (core) An advanced network fabric for Kubernetes
    mayastor             # (core) OpenEBS MayaStor
    metallb              # (core) Loadbalancer for your Kubernetes cluster
    metrics-server       # (core) K8s Metrics Server for API access to service metrics
    minio                # (core) MinIO object storage
    observability        # (core) A lightweight observability stack for logs, traces and metrics
    prometheus           # (core) Prometheus operator for monitoring and logging
    rbac                 # (core) Role-Based Access Control for authorisation
    registry             # (core) Private image registry exposed on localhost:32000
```

Enable ingress:

```shell
$ microk8s enable ingress
/snap/microk8s/5891/microk8s-enable.wrapper: line 9: warning: setlocale: LC_ALL: cannot change locale (C.UTF-8): No such file or directory
/snap/microk8s/5891/microk8s-enable.wrapper: line 9: warning: setlocale: LC_ALL: cannot change locale (C.UTF-8)
Infer repository core for addon ingress
bash: warning: setlocale: LC_ALL: cannot change locale (C.UTF-8)
Enabling Ingress
ingressclass.networking.k8s.io/public created
ingressclass.networking.k8s.io/nginx created
namespace/ingress created
serviceaccount/nginx-ingress-microk8s-serviceaccount created
clusterrole.rbac.authorization.k8s.io/nginx-ingress-microk8s-clusterrole created
role.rbac.authorization.k8s.io/nginx-ingress-microk8s-role created
clusterrolebinding.rbac.authorization.k8s.io/nginx-ingress-microk8s created
rolebinding.rbac.authorization.k8s.io/nginx-ingress-microk8s created
configmap/nginx-load-balancer-microk8s-conf created
configmap/nginx-ingress-tcp-microk8s-conf created
configmap/nginx-ingress-udp-microk8s-conf created
daemonset.apps/nginx-ingress-microk8s-controller created
Ingress is enabled
```

Enable cert-manager:

```shell
$ microk8s enable cert-manager
/snap/microk8s/5891/microk8s-enable.wrapper: line 9: warning: setlocale: LC_ALL: cannot change locale (C.UTF-8): No such file or directory
/snap/microk8s/5891/microk8s-enable.wrapper: line 9: warning: setlocale: LC_ALL: cannot change locale (C.UTF-8)
Infer repository core for addon cert-manager
/bin/bash: warning: setlocale: LC_ALL: cannot change locale (C.UTF-8)
Enable DNS addon
/bin/bash: warning: setlocale: LC_ALL: cannot change locale (C.UTF-8)
/snap/microk8s/5891/microk8s-enable.wrapper: line 9: warning: setlocale: LC_ALL: cannot change locale (C.UTF-8)
/snap/microk8s/5891/microk8s-enable.wrapper: line 9: warning: setlocale: LC_ALL: cannot change locale (C.UTF-8)
Infer repository core for addon dns
Addon core/dns is already enabled
Enabling cert-manager
/bin/bash: warning: setlocale: LC_ALL: cannot change locale (C.UTF-8)
namespace/cert-manager created
customresourcedefinition.apiextensions.k8s.io/certificaterequests.cert-manager.io created
customresourcedefinition.apiextensions.k8s.io/certificates.cert-manager.io created
customresourcedefinition.apiextensions.k8s.io/challenges.acme.cert-manager.io created
customresourcedefinition.apiextensions.k8s.io/clusterissuers.cert-manager.io created
customresourcedefinition.apiextensions.k8s.io/issuers.cert-manager.io created
customresourcedefinition.apiextensions.k8s.io/orders.acme.cert-manager.io created
serviceaccount/cert-manager-cainjector created
serviceaccount/cert-manager created
serviceaccount/cert-manager-webhook created
configmap/cert-manager-webhook created
clusterrole.rbac.authorization.k8s.io/cert-manager-cainjector created
clusterrole.rbac.authorization.k8s.io/cert-manager-controller-issuers created
clusterrole.rbac.authorization.k8s.io/cert-manager-controller-clusterissuers created
clusterrole.rbac.authorization.k8s.io/cert-manager-controller-certificates created
clusterrole.rbac.authorization.k8s.io/cert-manager-controller-orders created
clusterrole.rbac.authorization.k8s.io/cert-manager-controller-challenges created
clusterrole.rbac.authorization.k8s.io/cert-manager-controller-ingress-shim created
clusterrole.rbac.authorization.k8s.io/cert-manager-view created
clusterrole.rbac.authorization.k8s.io/cert-manager-edit created
clusterrole.rbac.authorization.k8s.io/cert-manager-controller-approve:cert-manager-io created
clusterrole.rbac.authorization.k8s.io/cert-manager-controller-certificatesigningrequests created
clusterrole.rbac.authorization.k8s.io/cert-manager-webhook:subjectaccessreviews created
clusterrolebinding.rbac.authorization.k8s.io/cert-manager-cainjector created
clusterrolebinding.rbac.authorization.k8s.io/cert-manager-controller-issuers created
clusterrolebinding.rbac.authorization.k8s.io/cert-manager-controller-clusterissuers created
clusterrolebinding.rbac.authorization.k8s.io/cert-manager-controller-certificates created
clusterrolebinding.rbac.authorization.k8s.io/cert-manager-controller-orders created
clusterrolebinding.rbac.authorization.k8s.io/cert-manager-controller-challenges created
clusterrolebinding.rbac.authorization.k8s.io/cert-manager-controller-ingress-shim created
clusterrolebinding.rbac.authorization.k8s.io/cert-manager-controller-approve:cert-manager-io created
clusterrolebinding.rbac.authorization.k8s.io/cert-manager-controller-certificatesigningrequests created
clusterrolebinding.rbac.authorization.k8s.io/cert-manager-webhook:subjectaccessreviews created
role.rbac.authorization.k8s.io/cert-manager-cainjector:leaderelection created
role.rbac.authorization.k8s.io/cert-manager:leaderelection created
role.rbac.authorization.k8s.io/cert-manager-webhook:dynamic-serving created
rolebinding.rbac.authorization.k8s.io/cert-manager-cainjector:leaderelection created
rolebinding.rbac.authorization.k8s.io/cert-manager:leaderelection created
rolebinding.rbac.authorization.k8s.io/cert-manager-webhook:dynamic-serving created
service/cert-manager created
service/cert-manager-webhook created
deployment.apps/cert-manager-cainjector created
deployment.apps/cert-manager created
deployment.apps/cert-manager-webhook created
mutatingwebhookconfiguration.admissionregistration.k8s.io/cert-manager-webhook created
validatingwebhookconfiguration.admissionregistration.k8s.io/cert-manager-webhook created
Waiting for cert-manager to be ready.
.ready
Enabled cert-manager
...
```

Enable RBAC:

```shell
$ microk8s enable rbac
/snap/microk8s/5891/microk8s-enable.wrapper: line 9: warning: setlocale: LC_ALL: cannot change locale (C.UTF-8): No such file or directory
/snap/microk8s/5891/microk8s-enable.wrapper: line 9: warning: setlocale: LC_ALL: cannot change locale (C.UTF-8)
Infer repository core for addon rbac
bash: warning: setlocale: LC_ALL: cannot change locale (C.UTF-8)
Enabling RBAC
Reconfiguring apiserver
[sudo] password for ei: 
Restarting apiserver
RBAC is enabled
```

Install load balancer:

Substibute `<ip-address>` below with the IP address of your server. 

```shell
$ microk8s enable metallb:"<ip-address>-<ip-address>"
/snap/microk8s/5891/microk8s-enable.wrapper: line 9: warning: setlocale: LC_ALL: cannot change locale (C.UTF-8): No such file or directory
/snap/microk8s/5891/microk8s-enable.wrapper: line 9: warning: setlocale: LC_ALL: cannot change locale (C.UTF-8)
Infer repository core for addon metallb
bash: warning: setlocale: LC_ALL: cannot change locale (C.UTF-8)
Enabling MetalLB
Applying Metallb manifest
/bin/bash: warning: setlocale: LC_ALL: cannot change locale (C.UTF-8)
$ microk8s enable rbac
/snap/microk8s/5891/microk8s-enable.wrapper: line 9: warning: setlocale: LC_ALL: cannot change locale (C.UTF-8): No such file or directory
/snap/microk8s/5891/microk8s-enable.wrapper: line 9: warning: setlocale: LC_ALL: cannot change locale (C.UTF-8)
Infer repository core for addon rbac
bash: warning: setlocale: LC_ALL: cannot change locale (C.UTF-8)
Enabling RBAC
Reconfiguring apiserver
[sudo] password for ei: 
Restarting apiserver
RBAC is enabled
customresourcedefinition.apiextensions.k8s.io/addresspools.metallb.io created
customresourcedefinition.apiextensions.k8s.io/bfdprofiles.metallb.io created
customresourcedefinition.apiextensions.k8s.io/bgpadvertisements.metallb.io created
customresourcedefinition.apiextensions.k8s.io/bgppeers.metallb.io created
customresourcedefinition.apiextensions.k8s.io/communities.metallb.io created
customresourcedefinition.apiextensions.k8s.io/ipaddresspools.metallb.io created
customresourcedefinition.apiextensions.k8s.io/l2advertisements.metallb.io created
/bin/bash: warning: setlocale: LC_ALL: cannot change locale (C.UTF-8)
namespace/metallb-system created
serviceaccount/controller created
serviceaccount/speaker created
clusterrole.rbac.authorization.k8s.io/metallb-system:controller created
clusterrole.rbac.authorization.k8s.io/metallb-system:speaker created
role.rbac.authorization.k8s.io/controller created
role.rbac.authorization.k8s.io/pod-lister created
clusterrolebinding.rbac.authorization.k8s.io/metallb-system:controller created
clusterrolebinding.rbac.authorization.k8s.io/metallb-system:speaker created
rolebinding.rbac.authorization.k8s.io/controller created
secret/webhook-server-cert created
service/webhook-service created
rolebinding.rbac.authorization.k8s.io/pod-lister created
daemonset.apps/speaker created
deployment.apps/controller created
validatingwebhookconfiguration.admissionregistration.k8s.io/validating-webhook-configuration created
Waiting for Metallb controller to be ready.
/bin/bash: warning: setlocale: LC_ALL: cannot change locale (C.UTF-8)
error: timed out waiting for the condition on deployments/controller
MetalLB controller is still not ready
/bin/bash: warning: setlocale: LC_ALL: cannot change locale (C.UTF-8)
deployment.apps/controller condition met
/bin/bash: warning: setlocale: LC_ALL: cannot change locale (C.UTF-8)
ipaddresspool.metallb.io/default-addresspool created
l2advertisement.metallb.io/default-advertise-all-pools created
MetalLB is enabled
```

Install the Contour ingress controller (see https://projectcontour.io):

```shell
$ kubectl apply -f https://projectcontour.io/quickstart/contour.yaml
namespace/projectcontour created
serviceaccount/contour created
serviceaccount/envoy created
configmap/contour created
customresourcedefinition.apiextensions.k8s.io/contourconfigurations.projectcontour.io created
customresourcedefinition.apiextensions.k8s.io/contourdeployments.projectcontour.io created
customresourcedefinition.apiextensions.k8s.io/extensionservices.projectcontour.io created
customresourcedefinition.apiextensions.k8s.io/httpproxies.projectcontour.io created
customresourcedefinition.apiextensions.k8s.io/tlscertificatedelegations.projectcontour.io created
serviceaccount/contour-certgen created
rolebinding.rbac.authorization.k8s.io/contour created
role.rbac.authorization.k8s.io/contour-certgen created
job.batch/contour-certgen-v1-26-0 created
clusterrolebinding.rbac.authorization.k8s.io/contour created
rolebinding.rbac.authorization.k8s.io/contour-rolebinding created
clusterrole.rbac.authorization.k8s.io/contour created
role.rbac.authorization.k8s.io/contour created
service/contour created
service/envoy created
deployment.apps/contour created
daemonset.apps/envoy created
```

### Step 3.2: Setup DNS

Point your domain and subdomains to the IP address of your server. 

(Cloudflare makes it easy and their free service is sufficient.)

### Step 3.3: Test DNS

TODO